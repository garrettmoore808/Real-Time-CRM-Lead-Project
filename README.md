# Real‑Time CRM Lead Processing & Notification System

## Overview

This serverless pipeline ingests CRM webhook events, enriches them with owner data after a delay, and sends notification emails.

## Architecture

```text
CRM Webhook → API Gateway → Ingestion Lambda → S3 (raw/) ↘
                                           ↘ SQS Delay Queue (10m)
                           Enrichment Lambda ← SQS ↙   ↘ S3 (enriched/) → SES Email
```

## Components

* **IngestionFunction**: Receives HTTP POST, writes raw JSON to S3, enqueues SQS with 10m delay.
* **DelayQueue**: Holds messages invisible for 10m, then triggers enrichment.
* **EnrichmentFunction**: Reads raw S3, fetches owner JSON from lookup bucket, writes enriched JSON, sends SES email.
* **S3 Buckets**:

  * `RawBucket`: Stores incoming payloads.
  * `LookupBucket`: Contains `lead_id.json` lookup files.
  * `EnrichedBucket`: Stores enriched payloads.
* **SES**: Sends email notifications.
* **DLQ**: Captures failed SQS messages after retries.

## Prerequisites

* AWS CLI v2 configured (us-east-1)
* AWS SAM CLI
* Verified SES email identity for `SES_FROM_ADDRESS`

## Deployment

```bash
cd ingestion-service
sam build
sam deploy --guided --capabilities CAPABILITY_IAM
```

Follow prompts using stack name `crm-ingestion-dev`.

## Usage / Testing

1. **Ingest**:

   ```bash
   curl -X POST https://<API_ID>.execute-api.us-east-1.amazonaws.com/Prod/ingest \
     -H "Content-Type: application/json" \
     -d '{"lead_id":"test-1","display_name":"Alice","lead_email":"alice@example.com"}'
   ```
2. **Simulate Enrichment Immediately**:

   ```bash
   aws sqs send-message --queue-url $DELAY_QUEUE_URL \
     --message-body '{"s3_key":"raw/crm_event_test-1_<timestamp>.json"}' \
     --delay-seconds 0
   ```
3. **Verify S3**:

   ```bash
   aws s3 ls s3://$RAW_BUCKET/raw/
   aws s3 ls s3://$ENRICHED_BUCKET/enriched/
   ```
4. **Check Email**: Ensure you receive a notification at `SES_TO_ADDRESS`.

## Code Structure

```
ingestion-service/
├── IngestionFunction/    # Lambda code for webhook ingestion
├── EnrichmentFunction/   # Lambda code for enrichment + email
├── template.yaml         # SAM template
└── README.md
```

## Error Handling & Observability

* **Retries**: SQS redrive to DLQ after 3 failed receives.
* **Logging**: Structured logs in CloudWatch for each Lambda.
* **Alerts**: Could add CloudWatch Alarms on DLQ depth or Lambda errors.

## Success Criteria

* Raw events in S3 within seconds.
* Enrichment only after 10m delay.
* Data merged accurately by `lead_id`.
* Email notifications sent promptly.
* Scales to parallel leads without collision.

---

*Generated by SAM; modify as needed for production.*
